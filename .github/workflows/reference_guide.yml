name: Deploy Doxygen Reference Guide to Docs Branch + Build Website

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout xtd source code (branch master)
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Install Graphviz (for Doxygen diagrams)
      run: sudo apt-get install graphviz

    - name: Generate Doxygen documentation
      uses: mattnotmitt/doxygen-action@v1.1.0

    - name: Checkout website sources (branch docs)
      uses: actions/checkout@v2
      with:
        ref: docs
        path: site-docs

    - name: Debug - Check website contents
      run: ls -al site-docs

    - name: Copy reference guide into website static folder
      run: |
        rm -rf site-docs/static/reference_guides/latest
        mkdir -p site-docs/static/reference_guides/latest
        cp -r reference_guide/html/* site-docs/static/reference_guides/latest/

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: npm
        cache-dependency-path: site-docs/package-lock.json

    - name: Install website dependencies
      working-directory: site-docs
      run: npm ci

    - name: Build website with Docusaurus
      working-directory: site-docs
      run: npm run build

    - name: Deploy full site to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@4.1.5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: docs
        folder: site-docs/build
        clean: true
